import{NextResponse as e}from"next/server";import{HEADER_LOCALE_NAME as o}from"../shared/constants.js";import{matchesPathname as l,normalizeTrailingSlash as r,getLocalePrefix as t}from"../shared/utils.js";import{receiveConfig as a}from"./config.js";import n from"./getAlternateLinksHeaderValue.js";import s from"./resolveLocale.js";import i from"./syncCookie.js";import{sanitizePathname as c,isLocaleSupportedOnDomain as d,getNormalizedPathname as f,getPathnameMatch as m,getInternalTemplate as h,formatTemplatePathname as x,formatPathname as u,getBestMatchingDomain as p,applyBasePath as v,getLocaleAsPrefix as U}from"./utils.js";function P(P){const g=a(P);return function(a){var P;const L=decodeURI(a.nextUrl.pathname),j=c(L),{domain:w,locale:k}=s(g,a.headers,a.cookies,j),b=w?w.defaultLocale===k:k===g.defaultLocale,y=(null===(P=g.domains)||void 0===P?void 0:P.filter((e=>d(k,e))))||[],R=null!=g.domains&&!w;function q(l){const r=new URL(l,a.url);a.nextUrl.basePath&&(r.pathname=v(r.pathname,a.nextUrl.basePath));const t=new Headers(a.headers);return t.set(o,k),e.rewrite(r,{request:{headers:t}})}function H(o,l){const t=new URL(r(o),a.url);if(y.length>0&&!l){const e=p(w,k,y);e&&(l=e.domain,e.defaultLocale===k&&"as-needed"===g.localePrefix.mode&&(t.pathname=f(t.pathname,g.locales,g.localePrefix)))}var n,s;l&&(t.host=l,a.headers.get("x-forwarded-host")&&(t.protocol=null!==(n=a.headers.get("x-forwarded-proto"))&&void 0!==n?n:a.nextUrl.protocol,t.port=null!==(s=a.headers.get("x-forwarded-port"))&&void 0!==s?s:""));return a.nextUrl.basePath&&(t.pathname=v(t.pathname,a.nextUrl.basePath)),e.redirect(t.toString())}const z=f(j,g.locales,g.localePrefix),A=m(j,g.locales,g.localePrefix),C=null!=A,D="never"===g.localePrefix.mode||b&&"as-needed"===g.localePrefix.mode;let I,S,V=z;if(g.pathnames){let e;if([e,S]=h(g.pathnames,z,k),S){const o=g.pathnames[S],r="string"==typeof o?o:o[k];if(l(r,z))V=x(z,r,S);else{let l;l=e?"string"==typeof o?o:o[e]:S;const n=D?void 0:t(k,g.localePrefix),s=x(z,l,r);I=H(u(s,n,a.nextUrl.search))}}}if(!I)if("/"!==V||C){const e=u(V,U(k),a.nextUrl.search);if(C){const o=u(z,A.prefix,a.nextUrl.search);if("never"===g.localePrefix.mode)I=H(u(z,void 0,a.nextUrl.search));else if(A.exact)if(b&&D)I=H(u(z,void 0,a.nextUrl.search));else if(g.domains){const l=p(w,A.locale,y);I=(null==w?void 0:w.domain)===(null==l?void 0:l.domain)||R?q(e):H(o,null==l?void 0:l.domain)}else I=q(e);else I=H(o)}else I=D?q(e):H(u(z,t(k,g.localePrefix),a.nextUrl.search))}else I=D?q(u(V,U(k),a.nextUrl.search)):H(u(z,t(k,g.localePrefix),a.nextUrl.search));var B;(g.localeDetection&&i(a,I,k),"never"!==g.localePrefix.mode&&g.alternateLinks&&g.locales.length>1)&&I.headers.set("Link",n({config:g,localizedPathnames:null!=S?null===(B=g.pathnames)||void 0===B?void 0:B[S]:void 0,request:a,resolvedLocale:k}));return I}}export{P as default};
