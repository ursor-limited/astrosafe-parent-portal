"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("next/server"),a=require("../shared/constants.js"),t=require("../shared/utils.js"),r=require("./config.js"),l=require("./getAlternateLinksHeaderValue.js"),o=require("./resolveLocale.js"),n=require("./syncCookie.js"),s=require("./utils.js");exports.default=function(i){const c=r.receiveConfig(i);return function(r){var i;const d=decodeURI(r.nextUrl.pathname),m=s.sanitizePathname(d),{domain:f,locale:h}=o.default(c,r.headers,r.cookies,m),u=f?f.defaultLocale===h:h===c.defaultLocale,x=(null===(i=c.domains)||void 0===i?void 0:i.filter((e=>s.isLocaleSupportedOnDomain(h,e))))||[],P=null!=c.domains&&!f;function p(t){const l=new URL(t,r.url);r.nextUrl.basePath&&(l.pathname=s.applyBasePath(l.pathname,r.nextUrl.basePath));const o=new Headers(r.headers);return o.set(a.HEADER_LOCALE_NAME,h),e.NextResponse.rewrite(l,{request:{headers:o}})}function g(a,l){const o=new URL(t.normalizeTrailingSlash(a),r.url);if(x.length>0&&!l){const e=s.getBestMatchingDomain(f,h,x);e&&(l=e.domain,e.defaultLocale===h&&"as-needed"===c.localePrefix.mode&&(o.pathname=s.getNormalizedPathname(o.pathname,c.locales,c.localePrefix)))}var n,i;l&&(o.host=l,r.headers.get("x-forwarded-host")&&(o.protocol=null!==(n=r.headers.get("x-forwarded-proto"))&&void 0!==n?n:r.nextUrl.protocol,o.port=null!==(i=r.headers.get("x-forwarded-port"))&&void 0!==i?i:""));return r.nextUrl.basePath&&(o.pathname=s.applyBasePath(o.pathname,r.nextUrl.basePath)),e.NextResponse.redirect(o.toString())}const v=s.getNormalizedPathname(m,c.locales,c.localePrefix),L=s.getPathnameMatch(m,c.locales,c.localePrefix),U=null!=L,q="never"===c.localePrefix.mode||u&&"as-needed"===c.localePrefix.mode;let j,w,y=v;if(c.pathnames){let e;if([e,w]=s.getInternalTemplate(c.pathnames,v,h),w){const a=c.pathnames[w],l="string"==typeof a?a:a[h];if(t.matchesPathname(l,v))y=s.formatTemplatePathname(v,l,w);else{let o;o=e?"string"==typeof a?a:a[e]:w;const n=q?void 0:t.getLocalePrefix(h,c.localePrefix),i=s.formatTemplatePathname(v,o,l);j=g(s.formatPathname(i,n,r.nextUrl.search))}}}if(!j)if("/"!==y||U){const e=s.formatPathname(y,s.getLocaleAsPrefix(h),r.nextUrl.search);if(U){const a=s.formatPathname(v,L.prefix,r.nextUrl.search);if("never"===c.localePrefix.mode)j=g(s.formatPathname(v,void 0,r.nextUrl.search));else if(L.exact)if(u&&q)j=g(s.formatPathname(v,void 0,r.nextUrl.search));else if(c.domains){const t=s.getBestMatchingDomain(f,L.locale,x);j=(null==f?void 0:f.domain)===(null==t?void 0:t.domain)||P?p(e):g(a,null==t?void 0:t.domain)}else j=p(e);else j=g(a)}else j=q?p(e):g(s.formatPathname(v,t.getLocalePrefix(h,c.localePrefix),r.nextUrl.search))}else j=q?p(s.formatPathname(y,s.getLocaleAsPrefix(h),r.nextUrl.search)):g(s.formatPathname(v,t.getLocalePrefix(h,c.localePrefix),r.nextUrl.search));var A;(c.localeDetection&&n.default(r,j,h),"never"!==c.localePrefix.mode&&c.alternateLinks&&c.locales.length>1)&&j.headers.set("Link",l.default({config:c,localizedPathnames:null!=w?null===(A=c.pathnames)||void 0===A?void 0:A[w]:void 0,request:r,resolvedLocale:h}));return j}};
